#!/bin/sh
if [ 0 != $(id -u) ] ; then
    echo "Must be root"
    exit
fi

if [ ! -d /tmp/flags ] ; then
    echo "Flags directory not found"
    exit
fi

echo "\033[1;32mDownloading files...\033[0m"
mkdir /tmp/bins
cd /tmp/bins
wget --output-document=download.tar.gz https://github.com/theKidOfArcrania/BinaryExploitPractice/releases/download/v1.0/binaries.tar.gz
echo "\n\033[1;32mUnzipping files...\033[0m"
tar -xvf download.tar.gz
rm download.tar.gz
chmod 755 *

echo "\n\033[1;32mWriting to disk...\033[0m"
for file in level*; do
    echo "\n\033[1;32mPreparing $file...\033[0m"
    
    if [ -f /tmp/flags/$file ] ; then
        flag=$(cat /tmp/flags/$file)
    else
        printf "Please enter flag: "
        read flag
    fi
    
    cd /tmp/bins
    
    if [ ! grep "^$file:" /etc/passwd 2> /dev/null > /dev/null ]; then
        useradd -m $file
    fi
	
    cp $file /home/$file/$file
    cd /home/$file
    chown root:$file $file
    chmod g+s $file
    
    echo $flag > flag.txt
    chown root:$file flag.txt
    chmod 740 flag.txt
done