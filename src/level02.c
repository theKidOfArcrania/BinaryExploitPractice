#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void readFlag()
{
    int file = open("flag.txt", O_RDONLY);
    if (!file) {
        puts("Unable to open flag.");
        exit(1);
    }
    
    char flag[100];
    read(file, flag, sizeof(flag));
    
    printf("The flag is: %s\n", flag);
    exit(0);
}

int main() {
	setresuid(getegid(), getegid(), getegid());
	setresgid(getegid(), getegid(), getegid());
	
    puts("This is my implementation of 'Guess the Number!' I");
    puts("generate a random 32-bit integer, you have to guess");
    puts("what this number is. If you get it right, you win!");
    
    game();
}

/**
 * Generates a secure random 32-bit signed integer. You do not
 * have to be knowledgable of its specifics, but it reads 4 bytes
 * from /dev/urandom.
 */
int randint() {
    int file = open("/dev/urandom", O_RDONLY);
    if (!file) {
        puts("Unable to generate random number.");
        exit(1);
    }
    
    int num;
    if (read(file, &num, sizeof(num)) != sizeof(num)) {
        puts("Unable to generate random number.");
        exit(1);
    }
    
    return num;
}

void game() {
    int guess;
    int secret = randint();
    char name[40];
    
    puts("\nWhat's your name?");
    gets(name);
    
    printf("\nHello %s! Please guess a 32-bit integer: ", name);
    scanf("%d", &guess);
    
    if (guess == secret) {
        puts("Yay! You guessed my number!");
        readFlag();
    } else {
        printf("Nope try again! My number was: %d", secret);
    }
}